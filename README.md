小米路由VPN智能分流配置
---

以下是**小米路由器2(1TB 硬盘版)**VPN智能分流的配置分享。家庭或公司科学上网需要用到VPN智能分流，仅让需要通过加速的外网流量走VPN通道，其余访问都还是继续走正常通道。小米路由的智能VPN分流可以按服务地址来选择哪些流量是从VPN出去的。其余的就按正常方式访问。只能分流依赖于一个需要分流的白名单。这里有一个实用的白名单，名单很长，不可能手工通过路由器的设置界面录入。因此需要开启路由器的开发模式，开启路由器上的ssh功能。开启ssh功能的方法网上有，这里就不赘述了。

#### 使用方法

proxy.txt 包含了一些需要分流的常用地址。你可以根据自己的需要添加一些自己需要的域名。开启小米路由的开发者模式，通过ssh访问小米路由。开启方法在小米官方有教程。把proxy.txt文件放在路由器的 /etc/smartvpn目录下，然后在路由器Web管理界面的“高级设置/VPN”中就可以看到这个清单了。此时断开VPN后从新链接就可以用了。

```
proxy.txt中的域名表示需要走VPN通道的网址，ip网段表示不理会域名必须走VPN通道的目标地址。

部分ip网段含义说明如下：
# Google ip
172.217.0.0/16
216.58.0.0/16

# 苹果ip
17.0.0.0/8
23.0.0.0/8
184.0.0.0/8

# Twitter
104.244.0.0/16
151.101.0.0/16
152.199.0.0/16

# 主流公共DNS（确保小米路由能够访问到正确的DNS）
1.0.0.0/15
8.8.0.0/16
9.9.0.0/16
149.112.0.0/16
208.67.0.0/16
```

#### 如何选择VPN供应商的问题

小米路支持接入的VPN仅支持PPP和L2TP两种，且L2TP还不支持IPSec。直接用小米路由的VPN连接海外是存在问题的，容易导致海外的服务器被封。解决的方案就是使用SoftEther来连接内地和海外，把其中一个SoftEther部署在与小米路由所在的局域网中，另一个SoftEther在海外。小米路由金需要通过VPN连接位于局域网内的SoftEther服务器，确保VPN服务稳定可靠。

SoftEther的功能非常强大，如果你具有比较丰富的网络路由知识，可以搭建一个香港和美国双出口的科学上网方案，让部分常用网站从香港出口访问，加快访问速度。具体配置方案参看[SoftEter配置案例.md](https://github.com/danielaskdd/smartvpn/blob/master/SoftEther%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B.md)，相关脚本也分享在本项目中。
