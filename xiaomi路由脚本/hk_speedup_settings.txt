=======================
=== 小米路由白名单设置 ===
=======================

小米路由科学上网的白名单为路由器上的 /etc/smartvpn/proxy.txt。文件上的域名访问流量将走VPN通道。

以下为不需要理会域名，必须走VPN通道的ip地址，需要添加到proxy.txt文件中：

# Google ip
172.217.0.0/16
216.58.0.0/16

# 苹果ip
17.0.0.0/8
23.0.0.0/8
184.28.0.0/16

# Twitter
104.244.0.0/16
152.199.0.0/16

# 主流公共DNS
1.0.0.0/15
8.8.0.0/16
9.9.0.0/16
149.112.0.0/16
208.67.0.0/16

============================
=== 美国Linode服务器SE配置 ===
============================
以下为VPN HUB的NAT配置

DHCP必须把以下DNS推送给客户端：（小米路由让这两个ip走VPN通道，确保dnsmasq能够访问到正确的DNS源）
   8.8.8.8
   1.1.1.1

把需要走香港出口的域名先关ip，通过静态路由表的方式推送给客户端（小米路由）：
1.1.1.0/24/192.168.30.2 1.0.0.0/24/192.168.30.2 172.65.251.0/24/192.168.30.2 172.217.160.0/19/192.168.30.2 172.217.0.0/19/192.168.30.2 216.58.192.0/19/192.168.30.2 216.239.32.0/19/192.168.30.2 35.190.31.0/24/192.168.30.2 35.190.55.0/24/192.168.30.2 104.244.40.0/21/192.168.30.2 152.199.32.0/19/192.168.30.2 17.91.8.0/21/192.168.30.2 17.91.64.0/19/192.168.30.2 17.248.128.0/18/192.168.30.2 17.253.0.0/16/192.168.30.2 23.7.192.0/18/192.168.30.2 23.198.112.0/20/192.168.30.2 23.198.128.0/20/192.168.30.2 184.28.34.0/23/192.168.30.2

以上ip的构成如下：

== 香港出口DNS路由
1.1.1.0/24/192.168.30.2
1.0.0.0/24/192.168.30.2

== GitLab香港路由
172.65.251.0/24/192.168.30.2	 						gitlab.com

== Google香港路由
172.217.160.0/19/192.168.30.2    172.217.160~191.xxx    m.google.com
172.217.0.0/19/192.168.30.2      172.217.0~31.xxx       m.youtube.com
216.58.192.0/19/192.168.30.2     216.58.192~223.xxx     m.youtube.com
216.239.32.0/19/192.168.30.2	 216.239.32~63.xxx      m.youtube.com

== 文学城香港路由
35.190.31.0/24/192.168.30.2
35.190.55.0/24/192.168.30.2

== Twitter香港路由
104.244.40.0/21/192.168.30.2     104.244.40~47.xxx
152.199.32.0/19/192.168.30.2     152.199.32~63.xxx      abs.twimg.com

== Apple香港路由
17.91.8.0/21/192.168.30.2        17.91.8~15.xxx
17.91.64.0/19/192.168.30.2       17.91.64~95.xxx
17.248.128.0/18/192.168.30.2     17.248.128~191.0     #
17.253.0.0/16/192.168.30.2       17.253.0~255.xxx 	  # iclould.com developer.apple.com
23.7.192.0/18/192.168.30.2       23.7.192~255.xxx     #
23.198.112.0/20/192.168.30.2     23.198.112~127.xxx
23.198.128.0/20/192.168.30.2     23.198.128~143.xxx
184.28.34.0/23/192.168.30.2      184.28.34~35.xxx

== 注意：以上规则错误地把以下非香港ip转到香港为出口，为避免规则太多太碎，暂时不予以纠正
216.58.195.238  是美国ip不是香港


=========================
==== 修改小米路由脚本 ======
=========================

== 停止VPN服务
== 让小米路由硬盘可写
mount -o remount, rw /

== 修正小米路错误：避免路由本地应用使用到VPN推送过来的DNS
修改 /usr/sbin/smartvpn.sh文件中的 dnsmasq_restart()函数，
在函数中的 /etc/init.d/dnsmasq restart 命令前插入以下语句：

    # remove DNS entry pushed by Softether
    sed -i -e '/nameserver 8.8.8.8/d' /tmp/resolv.conf.auto
    sed -i -e '/nameserver 1.1.1.1/d' /tmp/resolv.conf.auto

(8.8.8.8、1.1.1.1为SoftEther SecureNAT推送归来的DNS)

== 把上面静态路由表中涉及的域名的DNS改为使用1.1.1.1（从香港出口访问）
修改 /usr/sbin/gensmartdns.sh
找到 dnsserver="8.8.8.8" 替换相应的ip地址
在最后添加下以下语句：(把某些域名改为通过香港DNS访问，以获得香港ip）
    sed -i \
      -e '/server=\/google.com\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/googlevideo.com\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/youtube.com\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/youtu.be\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/twimg.com\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/twitter.com\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/developer.apple.com\// s/8.8.8.8/1.1.1.1/' \
      -e '/server=\/icloud.com\// s/8.8.8.8/1.1.1.1/' \
      $domain_file

== 让小米路由硬盘恢复只读
mount -o remount, ro /       # 恢复路由器文件只读
== 启动VPN服务